!function(t,s){"object"==typeof exports&&"object"==typeof module?module.exports=s():"function"==typeof define&&define.amd?define([],s):"object"==typeof exports?exports.SimplePS=s():t.SimplePS=s()}(self,(()=>(()=>{"use strict";var t={d:(s,e)=>{for(var r in e)t.o(e,r)&&!t.o(s,r)&&Object.defineProperty(s,r,{enumerable:!0,get:e[r]})},o:(t,s)=>Object.prototype.hasOwnProperty.call(t,s),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},s={};t.r(s),t.d(s,{BuiltIn:()=>y,Engine:()=>v});const e=new RegExp("[a-zA-Z_À-῿぀-㆏㐀-㴭一-鿿豈-﫿]"),r=new RegExp("[a-zA-Z_À-῿぀-㆏㐀-㴭一-鿿豈-﫿0-9]"),n=new RegExp("[0-9]");let i,o,a;function c(){let t=1,s=1;for(let e=0;e<o;e++)"\n"===i.charAt(e)?(t++,s=1):s++;return t+":"+s}function u(t){return i.charAt(o)===t?(o++,t):(a=`Error(${c()}) ここには文字「${t}」がこなければなりません。`,null)}function h(){const t=o;if(u("/")&&u("*"))for(;;){const s=o;if(u("*")&&u("/"))return"comment";if(o=s,""===i.charAt(o))return o=t,a=`Error(${c()}) ここにはコメントがこなければなりません。`,null;o++}return o=t,a=`Error(${c()}) ここにはコメントがこなければなりません。`,null}function l(){for(;;)if(!h()&&null==(u(" ")?" ":u("\t")?"\t":u("\n")?"\n":(a=`Error(${c()})`,null)))return"whiteSpace"}function g(){let t="",s=i.charAt(o);if(!s.match(e))return a=`Error(${c()}) ここには識別子がくるべきです。`,null;for(t+=s;;){if(o++,s=i.charAt(o),!s.match(r))return t;t+=s}}function m(){const t=o;return l(),""===i.charAt(o)?"EOF":(o=t,a=`Error(${c()}): EOF(入力の最後でなければなりません。`,null)}function d(){const t=o;let s=u('"');if(null==s&&(s=u("'")),null==s)return o=t,null;let e="";for(;;){const r=i.charAt(o);if(""===r)return o=t,a=`Error(${c()}) 文字列解析中に入力が終了しました。`,null;if(r===s){o++;break}e+=r,o++}return e}function f(){const t=o;let s=i.charAt(o);if("."!==s&&!s.match(n))return a=`Error(${c()}) ここには数字がこなければなりません。`,null;let e="";if("."===s){if(o++,s=i.charAt(o),!s.match(n))return o=t,null;o=t,s=i.charAt(o)}else for(e+=s,o++,s=i.charAt(o);s.match(n);)e+=s,o++,s=i.charAt(o);if("."===s)for(e+=s,o++,s=i.charAt(o);s.match(n);)e+=s,o++,s=i.charAt(o);if("e"===s||"E"===s)for(e+=s,o++,s=i.charAt(o),"+"!==s&&"-"!==s||(e+=s,o++,s=i.charAt(o));s.match(n);)e+=s,o++,s=i.charAt(o);return Number(e)}function A(){const t=o,s=g();if(null==s)return null;if(l(),null==u("("))return o=t,null;const e=[];for(;;){l(),","===i.charAt(o)&&o++,l();const t=g();if(t){e.push(new w(t));continue}const s=f();if(s){e.push(s);continue}const r=d();if(!r)break;e.push(r)}return l(),null==u(")")?(o=t,null):(l(),","===i.charAt(o)&&o++,new N(s,e))}function p(){const t=o;l();const s=f();if(null==s)return o=t,null;if(l(),null==u(":"))return o=t,null;const e=[];for(;;){l();const t=A();if(null==t)break;e.push(t)}if(0===e.length)return a=`Error(${c()}) 条件部(LHS)がありません。`,o=t,null;if(l(),null==u(">"))return o=t,null;const r=[];for(;;){l();const t=A();if(null==t)break;r.push(t)}return 0===r.length?(a=`Error(${c()}) 実行部(RHS)がありません。`,o=t,null):(l(),null==u(";")?(o=t,null):new I(s,e,r))}class w{name;constructor(t){this.name=t}}class N{name;args;constructor(t,s){this.name=t,this.args=s}toString(){let t="";return t+=this.name+"(",this.args.forEach((s=>{"number"==typeof s?t+=s+" ":"string"==typeof s?t+='"'+s+'" ':"Var"===s.constructor.name?t+=s.name+" ":t+="??? "})),t+=")",t}}class I{engine;priority;lhs;rhs;env;lastExecTime;constructor(t,s,e){this.priority=t,this.lhs=s,this.rhs=e,this.lastExecTime=-1}toString(){let t="";return t+=this.priority+": ",this.lhs.forEach((s=>{t+=s.toString()+" "})),t+="> ",this.rhs.forEach((s=>{t+=s.toString()+" "})),t+=";",t}checkConditions(){this.env={};for(let t=0;t<this.lhs.length;t++){const s=this.lhs[t],e=this.engine.builtIns[s.name];if(!e)return console.log(`${s.name}という名前のビルトインが見付かりません。`),!1;try{if(!e.preEval(s.args,this.env))return!1}catch(t){return console.log(t),!1}}return!0}isNewSituation(){let t=!1;t:for(let s=0;s<this.lhs.length;s++){const e=this.lhs[s];for(let s=0;s<e.args.length;s++){const r=e.args[s];if("Var"===r.constructor.name){const s=this.engine.getInfoUpdateTime(r.name);if(s>this.lastExecTime){t=!0;break t}if("no"===e.name&&void 0===s){t=!0;break t}}}}return t}doActions(){this.lastExecTime=this.engine.workingMemoryTime,this.rhs.forEach((t=>{const s=this.engine.builtIns[t.name];if(s)try{s.preEval(t.args,this.env)}catch(t){return void console.log(t)}else console.log(`${t.name}という名前のビルトインが見付かりません。`)}))}}class y{name;engine;args;env;constructor(t){this.name=t}preEval(t,s){return this.args=t,this.env=s,this.eval()}eval(){}getArgsNum(){return this.args.length}checkArgsNum(t){if(this.args.length!=t)throw new Error(`${this.name}(${this.constructor.name}) 必ず${t}の引数を指定して下さい。`)}getArgAsName(t){if("Var"!=this.args[t].constructor.name)throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は変数でなければなりません。`);return this.args[t].name}getArgAsNum(t){if("number"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const s=this.env[this.args[t].name];if("number"==typeof s)return s;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は数値でなければなりません。`)}getArgAsStr(t){if("string"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const s=this.env[this.args[t].name];if("string"==typeof s)return s;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は文字列でなければなりません。`)}getArgIfNotEmpty(t){if("number"==typeof this.args[t])return this.args[t];if("string"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const s=this.env[this.args[t].name];if("number"==typeof s)return s;if("string"==typeof s)return s;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は不明な値です。`)}getArg(t){if("number"==typeof this.args[t])return this.args[t];if("string"==typeof this.args[t])return this.args[t];if("Var"===this.args[t].constructor.name)return this.env[this.args[t].name];throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}setVar(t,s){this.env[t]=s}getVar(t){return this.env[t]}setOneInfoToWM(t,s){this.engine.setOneInfoToWM(t,s)}setInfoToWM(t){this.engine.setInfoToWM(t)}getInfoFromWM(t){return this.engine.getInfoFromWM(t)}delInfoFromWM(t){this.engine.delInfoFromWM(t)}}class v{rules;builtIns;workingMemory;workingMemoryTime;inferStatus;timeoutID;constructor(t){this.rules=void 0===t?[]:function(t){i=t,o=0,a="";const s=function(){const t=o,s=[];for(;!m();){l();const e=p();if(!e)return o=t,null;s.push(e)}return s}();return null===s?a:s}(t),this.rules.forEach((t=>{t.engine=this})),this.builtIns={},this.workingMemory={},this.workingMemoryTime=0,this.inferStatus="stoped",this.timeoutID=0,this.addBuiltIn(new k),this.addBuiltIn(new E),this.addBuiltIn(new $),this.addBuiltIn(new S),this.addBuiltIn(new M),this.addBuiltIn(new b),this.addBuiltIn(new x),this.addBuiltIn(new B),this.addBuiltIn(new T),this.addBuiltIn(new F),this.addBuiltIn(new W),this.addBuiltIn(new V),this.addBuiltIn(new j),this.addBuiltIn(new O),this.addBuiltIn(new R),this.addBuiltIn(new P),this.addBuiltIn(new D),this.addBuiltIn(new q),this.addBuiltIn(new H),this.addBuiltIn(new L),this.addBuiltIn(new _),this.addBuiltIn(new z),this.addBuiltIn(new C),this.addBuiltIn(new G),this.addBuiltIn(new U),this.addBuiltIn(new Z),this.addBuiltIn(new J),this.addBuiltIn(new K),this.addBuiltIn(new Q),this.addBuiltIn(new X),this.addBuiltIn(new Y)}addBuiltIn(t){t.engine=this,this.builtIns[t.name]=t}setOneInfoToWM(t,s){switch(this.workingMemoryTime++,void 0===s&&(s=null),this.workingMemory[t]={updateTime:this.workingMemoryTime,value:s},this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":break;case"standby":this.justStart()}}setInfoToWM(t){switch(this.workingMemoryTime++,Object.keys(t).forEach((s=>{const e=t[s];void 0===e&&(e=null),this.workingMemory[s]={updateTime:this.workingMemoryTime,value:e}})),this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":break;case"standby":this.justStart()}}getInfoFromWM(t){const s=this.workingMemory[t];if(s)return s.value}delInfoFromWM(t){switch(delete this.workingMemory[t],this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":break;case"standby":this.justStart()}}getInfoUpdateTime(t){const s=this.workingMemory[t];if(s)return s.updateTime}dumpWM(){let t="[WM update="+this.workingMemoryTime+"]";return Object.keys(this.workingMemory).forEach((s=>{t+=s+":",t+=this.workingMemory[s].value+"(",t+=this.workingMemory[s].updateTime+") "})),t}justStart(){console.trace("GAHA"),this.timeoutID=setTimeout((()=>{this.inferLoop()}),0),this.inferStatus="waitForRun"}start(){switch(this.inferStatus){case"stoped":case"standby":case"waitForStop":this.justStart()}}inferLoop(){switch(console.log("GAHA0:Engine.inferLoop() ******************************"),this.inferStatus){case"stoped":return;case"waitForRun":case"running":case"standby":break;case"waitForStop":return void(this.inferStatus="stoped")}this.inferStatus="running";let t=[];this.rules.forEach((s=>{s.checkConditions(this.workingMemory)&&t.push(s)}));const s=[];t.forEach((t=>{t.isNewSituation()&&s.push(t)})),t=s;let e=-1,r=null;t.forEach((t=>{e<t.priority&&(r=t,e=t.priority)})),null!==r?(r.doActions(),this.justStart()):this.inferStatus="standby"}stop(){switch(this.inferStatus){case"stoped":case"running":case"waitForStop":break;case"waitForRun":clearTimeout(this.timeoutID),this.inferStatus="stoped";break;case"standby":this.inferStatus="stoped"}}}class k extends y{constructor(){super("s")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0),s=this.getInfoFromWM(t);return void 0!==s&&(this.setVar(t,s),!0)}}class E extends y{constructor(){super("no")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);return void 0===this.getInfoFromWM(t)}}class $ extends y{constructor(){super("gt")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)>this.getArgAsNum(1)}}class S extends y{constructor(){super("lt")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)<this.getArgAsNum(1)}}class M extends y{constructor(){super("ge")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)>=this.getArgAsNum(1)}}class b extends y{constructor(){super("le")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)<=this.getArgAsNum(1)}}class x extends y{constructor(){super("eq")}eval(){return this.checkArgsNum(2),this.getArgIfNotEmpty(0)===this.getArgIfNotEmpty(1)}}class B extends y{constructor(){super("neq")}eval(){return this.checkArgsNum(2),this.getArgIfNotEmpty(0)!==this.getArgIfNotEmpty(1)}}class T extends y{constructor(){super("range")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1);if(s>this.getArgAsNum(2))throw new Error("range(RangeBI) (第2引数 <= 第3引数) でなければなりません。");return!(s>=t||d2<=d3)}}class F extends y{constructor(){super("range2")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1);if(s>=this.getArgAsNum(2))throw new Error("range(RangeBI) 第2引数 < 第3引数 でなければなりません。");return!(s>t||d2<d3)}}class W extends y{constructor(){super("seq")}eval(){this.checkArgsNum(2);const t=this.getArgAsName(0),s=this.getInfoFromWM(t);return void 0!==s&&(this.setVar(t,s),s===this.getArg(1))}}class V extends y{constructor(){super("sgt")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class j extends y{constructor(){super("slt")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class O extends y{constructor(){super("sge")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class R extends y{constructor(){super("sle")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class P extends y{constructor(){super("set")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class D extends y{constructor(){super("st")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0),s=this.getVar(t);return this.setOneInfoToWM(t,s),!0}}class q extends y{constructor(){super("st2")}eval(){this.checkArgsNum(2);const t=this.getArgAsName(0),s=this.getArg(1);this.setOneInfoToWM(t,s)}}class H extends y{constructor(){super("del")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);this.delInfoFromWM(t)}}class L extends y{constructor(){super("add")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1),e=this.getArgAsName(2);this.setVar(e,t+s)}}class _ extends y{constructor(){super("sub")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1),e=this.getArgAsName(2);this.setVar(e,t-s)}}class z extends y{constructor(){super("mul")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1),e=this.getArgAsName(2);this.setVar(e,t*s)}}class C extends y{constructor(){super("div")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1),e=this.getArgAsName(2);if(0===s)throw new Error("div(DivBI) 割る数が0です。");this.setVar(e,t/s)}}class G extends y{constructor(){super("concat")}eval(){this.checkArgsNum(3);const t=this.getArgAsStr(0),s=this.getArgAsStr(1),e=this.getArgAsName(2);this.setVar(e,t+s)}}class U extends y{constructor(){super("log")}eval(){let t="";const s=this.getArgsNum();for(let e=0;e<s;e++)t+=this.getArg(e);console.log(t)}}class Z extends y{constructor(){super("rand")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);this.setVar(t,Math.random())}}class J extends y{constructor(){super("mod")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),s=this.getArgAsNum(1),e=this.getArgAsName(2);if(0===s)throw new Error("mod(ModBI) 割る数が0です。");const r=t/s,n=t-s*Math.floor(r);this.setVar(e,n)}}class K extends y{constructor(){super("floor")}eval(){this.checkArgsNum(2);const t=this.getArgAsNum(0),s=this.getArgAsName(1);this.setVar(s,Math.floor(t))}}class Q extends y{constructor(){super("sneq")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class X extends y{constructor(){super("stop")}eval(){this.engine.stop(),console.log("stop(StopBI) 推論エンジンを停止させます。")}}class Y extends y{constructor(){super("wm")}eval(){const t=this.engine.dumpWM();console.log(t)}}return s})()));