!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SimplePS=e():t.SimplePS=e()}(self,(()=>(()=>{"use strict";var t={d:(e,s)=>{for(var r in s)t.o(s,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:s[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{BuiltIn:()=>I,Engine:()=>N});const s=new RegExp("[a-zA-Z_À-῿぀-㆏㐀-㴭一-鿿豈-﫿]"),r=new RegExp("[a-zA-Z_À-῿぀-㆏㐀-㴭一-鿿豈-﫿0-9]"),n=new RegExp("[0-9]");let i,o,a;function u(){let t=1,e=1;for(let s=0;s<o;s++)"\n"===i.charAt(s)?(t++,e=1):e++;return t+":"+e}function c(t){return i.charAt(o)===t?(o++,t):(a=`Error(${u()}) ここには文字「${t}」がこなければなりません。`,null)}function h(){const t=o;if(c("/")&&c("*"))for(;;){const e=o;if(c("*")&&c("/"))return"comment";if(o=e,""===i.charAt(o))return o=t,a=`Error(${u()}) ここにはコメントがこなければなりません。`,null;o++}return o=t,a=`Error(${u()}) ここにはコメントがこなければなりません。`,null}function l(){for(;;)if(!h()&&null==(c(" ")?" ":c("\t")?"\t":c("\n")?"\n":(a=`Error(${u()})`,null)))return"whiteSpace"}function g(){let t="",e=i.charAt(o);if(!e.match(s))return a=`Error(${u()}) ここには識別子がくるべきです。`,null;for(t+=e;;){if(o++,e=i.charAt(o),!e.match(r))return t;t+=e}}function m(){const t=o;return l(),""===i.charAt(o)?"EOF":(o=t,a=`Error(${u()}): EOF(入力の最後でなければなりません。`,null)}function d(){const t=o;let e=c('"');if(null==e&&(e=c("'")),null==e)return o=t,null;let s="";for(;;){const r=i.charAt(o);if(""===r)return o=t,a=`Error(${u()}) 文字列解析中に入力が終了しました。`,null;if(r===e){o++;break}s+=r,o++}return s}function f(){const t=o;let e=i.charAt(o);if("."!==e&&!e.match(n))return a=`Error(${u()}) ここには数字がこなければなりません。`,null;let s="";if("."===e){if(o++,e=i.charAt(o),!e.match(n))return o=t,null;o=t,e=i.charAt(o)}else for(s+=e,o++,e=i.charAt(o);e.match(n);)s+=e,o++,e=i.charAt(o);if("."===e)for(s+=e,o++,e=i.charAt(o);e.match(n);)s+=e,o++,e=i.charAt(o);if("e"===e||"E"===e)for(s+=e,o++,e=i.charAt(o),"+"!==e&&"-"!==e||(s+=e,o++,e=i.charAt(o));e.match(n);)s+=e,o++,e=i.charAt(o);return Number(s)}function A(){const t=o,e=g();if(null==e)return null;if(l(),null==c("("))return o=t,null;const s=[];for(;;){l(),","===i.charAt(o)&&o++,l();const t=g();if(t){s.push(new w(t));continue}const e=f();if(e){s.push(e);continue}const r=d();if(!r)break;s.push(r)}return l(),null==c(")")?(o=t,null):(l(),","===i.charAt(o)&&o++,new y(e,s))}function p(){const t=o;l();const e=f();if(null==e)return o=t,null;if(l(),null==c(":"))return o=t,null;const s=[];for(;;){l();const t=A();if(null==t)break;s.push(t)}if(0===s.length)return a=`Error(${u()}) 条件部(LHS)がありません。`,o=t,null;if(l(),null==c(">"))return o=t,null;const r=[];for(;;){l();const t=A();if(null==t)break;r.push(t)}return 0===r.length?(a=`Error(${u()}) 実行部(RHS)がありません。`,o=t,null):(l(),null==c(";")?(o=t,null):new v(e,s,r))}class w{name;constructor(t){this.name=t}}class y{name;args;constructor(t,e){this.name=t,this.args=e}toString(){let t="";return t+=this.name+"(",this.args.forEach((e=>{"number"==typeof e?t+=e+" ":"string"==typeof e?t+='"'+e+'" ':"Var"===e.constructor.name?t+=e.name+" ":t+="??? "})),t+=")",t}}class v{engine;priority;lhs;rhs;env;lastExecTime;constructor(t,e,s){this.priority=t,this.lhs=e,this.rhs=s,this.lastExecTime=-1}toString(){let t="";return t+=this.priority+": ",this.lhs.forEach((e=>{t+=e.toString()+" "})),t+="> ",this.rhs.forEach((e=>{t+=e.toString()+" "})),t+=";",t}checkConditions(){this.env={};for(let t=0;t<this.lhs.length;t++){const e=this.lhs[t],s=this.engine.builtIns[e.name];if(!s)return console.log(`${e.name}という名前のビルトインが見付かりません。`),!1;try{if(!s.preEval(e.args,this.env))return!1}catch(t){return console.log(t),!1}}return!0}isNewSituation(){let t=!1;t:for(let e=0;e<this.lhs.length;e++){const s=this.lhs[e];for(let e=0;e<s.args.length;e++){const r=s.args[e];if("Var"===r.constructor.name){const e=this.engine.getInfoUpdateTime(r.name);if(e>this.lastExecTime){t=!0;break t}if("no"===s.name&&void 0===e){t=!0;break t}}}}return t}doActions(){this.lastExecTime=this.engine.workingMemoryTime,this.rhs.forEach((t=>{const e=this.engine.builtIns[t.name];if(e)try{e.preEval(t.args,this.env)}catch(t){return void console.log(t)}else console.log(`${t.name}という名前のビルトインが見付かりません。`)}))}}class I{name;engine;args;env;constructor(t){this.name=t}preEval(t,e){return this.args=t,this.env=e,this.eval()}eval(){}getArgsNum(){return this.args.length}checkArgsNum(t){if(this.args.length!=t)throw new Error(`${this.name}(${this.constructor.name}) 必ず${t}の引数を指定して下さい。`)}getArgAsName(t){if("Var"!=this.args[t].constructor.name)throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は変数でなければなりません。`);return this.args[t].name}getArgAsNum(t){if("number"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const e=this.env[this.args[t].name];if("number"==typeof e)return e;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は数値でなければなりません。`)}getArgAsStr(t){if("string"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const e=this.env[this.args[t].name];if("string"==typeof e)return e;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は文字列でなければなりません。`)}getArgIfNotEmpty(t){if("number"==typeof this.args[t])return this.args[t];if("string"==typeof this.args[t])return this.args[t];if("Var"==this.args[t].constructor.name){const e=this.env[this.args[t].name];if("number"==typeof e)return e;if("string"==typeof e)return e;throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数は不明な値です。`)}getArg(t){if("number"==typeof this.args[t])return this.args[t];if("string"==typeof this.args[t])return this.args[t];if("Var"===this.args[t].constructor.name)return this.env[this.args[t].name];throw new Error(`${this.name}(${this.constructor.name}) ${t+1}番目の引数の変数は空でした。`)}setVar(t,e){this.env[t]=e}getVar(t){return this.env[t]}addInfoToWM(t){this.engine.addInfoToWM(t)}addOneInfoToWM(t,e){this.engine.addOneInfoToWM(t,e)}getInfoFromWM(t){return this.engine.getInfoFromWM(t)}delInfoFromWM(t){this.engine.delInfoFromWM(t)}clearWM(){this.engine.clearWM()}}class N{rules;builtIns;workingMemory;workingMemoryTime;inferStatus;timeoutID;constructor(t){this.rules=void 0===t?[]:function(t){i=t,o=0,a="";const e=function(){const t=o,e=[];for(;!m();){l();const s=p();if(!s)return o=t,null;e.push(s)}return e}();return null===e?a:e}(t),this.rules.forEach((t=>{t.engine=this})),this.builtIns={},this.workingMemory={},this.workingMemoryTime=0,this.inferStatus="stoped",this.timeoutID=0,this.addBuiltIn(new S),this.addBuiltIn(new k),this.addBuiltIn(new M),this.addBuiltIn(new E),this.addBuiltIn(new b),this.addBuiltIn(new $),this.addBuiltIn(new T),this.addBuiltIn(new x),this.addBuiltIn(new B),this.addBuiltIn(new F),this.addBuiltIn(new R),this.addBuiltIn(new W),this.addBuiltIn(new V),this.addBuiltIn(new j),this.addBuiltIn(new O),this.addBuiltIn(new P),this.addBuiltIn(new D),this.addBuiltIn(new q),this.addBuiltIn(new _),this.addBuiltIn(new L),this.addBuiltIn(new z),this.addBuiltIn(new C),this.addBuiltIn(new H),this.addBuiltIn(new U),this.addBuiltIn(new Z),this.addBuiltIn(new G),this.addBuiltIn(new J),this.addBuiltIn(new K),this.addBuiltIn(new Q),this.addBuiltIn(new X),this.addBuiltIn(new Y),this.resultBI=new tt,this.addBuiltIn(this.resultBI)}addBuiltIn(t){t.engine=this,this.builtIns[t.name]=t}addInfoToWM(t){switch(this.workingMemoryTime++,Object.keys(t).forEach((e=>{const s=t[e];void 0===s&&(s=null),this.workingMemory[e]={updateTime:this.workingMemoryTime,value:s}})),this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":case"oneTime":break;case"standby":this.justStart(),this.inferStatus="waitForRun"}}addOneInfoToWM(t,e){void 0===e&&(e=null);const s={};s[t]=e,this.addInfoToWM(s)}setInfoToWM(t){switch(this.workingMemoryTime++,this.workingMemory={},Object.keys(t).forEach((e=>{const s=t[e];void 0===s&&(s=null),this.workingMemory[e]={updateTime:this.workingMemoryTime,value:s}})),this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":case"oneTime":break;case"standby":this.justStart(),this.inferStatus="waitForRun"}}getInfoFromWM(t){const e=this.workingMemory[t];if(e)return e.value}delInfoFromWM(t){switch(this.workingMemoryTime++,delete this.workingMemory[t],this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":case"oneTime":break;case"standby":this.justStart(),this.inferStatus="waitForRun"}}clearWM(t){switch(this.workingMemoryTime++,this.workingMemory={},this.inferStatus){case"stoped":case"waitForRun":case"running":case"waitForStop":case"oneTime":break;case"standby":this.justStart(),this.inferStatus="waitForRun"}}getInfoUpdateTime(t){const e=this.workingMemory[t];if(e)return e.updateTime}dumpWM(){let t="[WM update="+this.workingMemoryTime+"]";return Object.keys(this.workingMemory).forEach((e=>{t+=e+":",t+=this.workingMemory[e].value+"(",t+=this.workingMemory[e].updateTime+") "})),t}justStart(){this.timeoutID=setTimeout((()=>{this.inferLoop()}),0),this.inferStatus="waitForRun"}start(){switch(this.inferStatus){case"stoped":case"standby":case"waitForStop":this.justStart(),this.inferStatus="waitForRun"}}inferOneStep(){switch(this.inferStatus){case"stoped":case"standby":case"oneTime":this.justStart(),this.inferStatus="oneTime";break;case"waitForRun":case"waitForStop":this.inferStatus="oneTime"}}async inferOneStepAndWait(t){switch(this.inferStatus){case"stoped":case"standby":case"oneTime":this.justStart(),this.inferStatus="oneTime";break;case"waitForRun":case"waitForStop":this.inferStatus="oneTime"}return await this.resultBI.getResult(t)}inferLoop(){let t=!1;switch(this.inferStatus){case"stoped":return;case"waitForRun":case"running":case"standby":break;case"waitForStop":return void(this.inferStatus="stoped");case"oneTime":t=!0}this.inferStatus="running";let e=[];this.rules.forEach((t=>{t.checkConditions(this.workingMemory)&&e.push(t)}));const s=[];e.forEach((t=>{t.isNewSituation()&&s.push(t)})),e=s;let r=-1,n=null;e.forEach((t=>{r<t.priority&&(n=t,r=t.priority)})),null!==n?(n.doActions(),!0===t?this.inferStatus="oneTime":(this.justStart(),this.inferStatus="waitForRun")):this.inferStatus="standby"}stop(){switch(this.inferStatus){case"stoped":case"running":case"waitForStop":case"oneTime":break;case"waitForRun":clearTimeout(this.timeoutID),this.inferStatus="stoped";break;case"standby":this.inferStatus="stoped"}}}class S extends I{constructor(){super("s")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0),e=this.getInfoFromWM(t);return void 0!==e&&(this.setVar(t,e),!0)}}class k extends I{constructor(){super("no")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);return void 0===this.getInfoFromWM(t)}}class M extends I{constructor(){super("gt")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)>this.getArgAsNum(1)}}class E extends I{constructor(){super("lt")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)<this.getArgAsNum(1)}}class b extends I{constructor(){super("ge")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)>=this.getArgAsNum(1)}}class $ extends I{constructor(){super("le")}eval(){return this.checkArgsNum(2),this.getArgAsNum(0)<=this.getArgAsNum(1)}}class T extends I{constructor(){super("eq")}eval(){return this.checkArgsNum(2),this.getArgIfNotEmpty(0)===this.getArgIfNotEmpty(1)}}class x extends I{constructor(){super("neq")}eval(){return this.checkArgsNum(2),this.getArgIfNotEmpty(0)!==this.getArgIfNotEmpty(1)}}class B extends I{constructor(){super("range")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1);if(e>this.getArgAsNum(2))throw new Error("range(RangeBI) (第2引数 <= 第3引数) でなければなりません。");return!(e>=t||d2<=d3)}}class F extends I{constructor(){super("range2")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1);if(e>=this.getArgAsNum(2))throw new Error("range(RangeBI) 第2引数 < 第3引数 でなければなりません。");return!(e>t||d2<d3)}}class R extends I{constructor(){super("seq")}eval(){this.checkArgsNum(2);const t=this.getArgAsName(0),e=this.getInfoFromWM(t);return void 0!==e&&(this.setVar(t,e),e===this.getArg(1))}}class W extends I{constructor(){super("sgt")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class V extends I{constructor(){super("slt")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class j extends I{constructor(){super("sge")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class O extends I{constructor(){super("sle")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class P extends I{constructor(){super("set")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class D extends I{constructor(){super("st")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0),e=this.getVar(t);return this.addOneInfoToWM(t,e),!0}}class q extends I{constructor(){super("st2")}eval(){this.checkArgsNum(2);const t=this.getArgAsName(0),e=this.getArg(1);this.addOneInfoToWM(t,e)}}class _ extends I{constructor(){super("del")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);this.delInfoFromWM(t)}}class L extends I{constructor(){super("add")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1),s=this.getArgAsName(2);this.setVar(s,t+e)}}class z extends I{constructor(){super("sub")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1),s=this.getArgAsName(2);this.setVar(s,t-e)}}class C extends I{constructor(){super("mul")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1),s=this.getArgAsName(2);this.setVar(s,t*e)}}class H extends I{constructor(){super("div")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1),s=this.getArgAsName(2);if(0===e)throw new Error("div(DivBI) 割る数が0です。");this.setVar(s,t/e)}}class U extends I{constructor(){super("concat")}eval(){this.checkArgsNum(3);const t=this.getArgAsStr(0),e=this.getArgAsStr(1),s=this.getArgAsName(2);this.setVar(s,t+e)}}class Z extends I{constructor(){super("log")}eval(){let t="";const e=this.getArgsNum();for(let s=0;s<e;s++)t+=this.getArg(s);console.log(t)}}class G extends I{constructor(){super("rand")}eval(){this.checkArgsNum(1);const t=this.getArgAsName(0);this.setVar(t,Math.random())}}class J extends I{constructor(){super("mod")}eval(){this.checkArgsNum(3);const t=this.getArgAsNum(0),e=this.getArgAsNum(1),s=this.getArgAsName(2);if(0===e)throw new Error("mod(ModBI) 割る数が0です。");const r=t/e,n=t-e*Math.floor(r);this.setVar(s,n)}}class K extends I{constructor(){super("floor")}eval(){this.checkArgsNum(2);const t=this.getArgAsNum(0),e=this.getArgAsName(1);this.setVar(e,Math.floor(t))}}class Q extends I{constructor(){super("sneq")}eval(){console.log(`${this.name}(${this.constructor.name}) is not implemented yet!`)}}class X extends I{constructor(){super("stop")}eval(){this.engine.stop(),console.log("stop(StopBI) 推論エンジンを停止させます。")}}class Y extends I{constructor(){super("wm")}eval(){const t=this.engine.dumpWM();console.log(t)}}class tt extends I{reservedResult=null;resolvePromiseFunc=null;constructor(){super("result")}eval(){this.checkArgsNum(1);const t=this.getArg(0);this.resolvePromiseFunc?(this.resolvePromiseFunc(t),this.resolvePromiseFunc=null):this.reservedResult=t}async getResult(t){return new Promise(((e,s)=>{this.reservedResult?(e(this.reservedResult),this.reservedResult=null):this.resolvePromiseFunc=e,setTimeout((()=>{e("Timeout!")}),t)}))}}return e})()));